# ç¼–è¯‘å™¨
CXX = g++
CXXFLAGS = -std=c++11 -Wall -O2 -Iinclude

# ç›®å½•
SRCDIR = src
INCDIR = include
LIBDIR = lib
BINDIR = bin

# æºæ–‡ä»¶
SRCS = $(wildcard $(SRCDIR)/*.cpp)
OBJS = $(SRCS:$(SRCDIR)/%.cpp=$(LIBDIR)/%.o)

# ç›®æ ‡åº“
LIB_TARGET = $(LIBDIR)/libnbt.a
SHARED_TARGET = $(LIBDIR)/libnbt.so

# æµ‹è¯•ç¨‹åºï¼ˆå¦‚æœæœ‰ï¼‰
TEST_SRC = test.cpp
TEST_TARGET = $(BINDIR)/nbt-test

# é»˜è®¤ç›®æ ‡
all: dirs static shared

# åˆ›å»ºç›®å½•
dirs:
	@mkdir -p $(LIBDIR) $(BINDIR)

# é™æ€åº“
static: $(LIB_TARGET)

$(LIB_TARGET): $(OBJS)
	ar rcs $@ $^
	@echo "âœ… é™æ€åº“å·²åˆ›å»º: $@"

# åŠ¨æ€åº“
shared: $(SHARED_TARGET)

$(SHARED_TARGET): $(OBJS)
	$(CXX) -shared -o $@ $^
	@echo "âœ… åŠ¨æ€åº“å·²åˆ›å»º: $@"

# ç¼–è¯‘ç›®æ ‡æ–‡ä»¶
$(LIBDIR)/%.o: $(SRCDIR)/%.cpp
	$(CXX) $(CXXFLAGS) -fPIC -c $< -o $@
	@echo "ğŸ”¨ ç¼–è¯‘: $<"

# æµ‹è¯•ç¨‹åºï¼ˆå¦‚æœæœ‰ test.cppï¼‰
test: dirs $(LIB_TARGET)
	$(CXX) $(CXXFLAGS) -o $(TEST_TARGET) $(TEST_SRC) -L$(LIBDIR) -lnbt
	@echo "âœ… æµ‹è¯•ç¨‹åºå·²åˆ›å»º: $(TEST_TARGET)"

# è¿è¡Œæµ‹è¯•
run-test: test
	@$(TEST_TARGET)

# å®‰è£…åˆ°ç³»ç»Ÿï¼ˆéœ€è¦ sudoï¼‰
install: static shared
	@echo "ğŸ“¦ å®‰è£…å¤´æ–‡ä»¶åˆ° /usr/local/include/nbt/"
	@sudo mkdir -p /usr/local/include/nbt
	@sudo cp $(INCDIR)/*.h /usr/local/include/nbt/
	@echo "ğŸ“¦ å®‰è£…åº“åˆ° /usr/local/lib/"
	@sudo cp $(LIB_TARGET) $(SHARED_TARGET) /usr/local/lib/
	@sudo ldconfig
	@echo "âœ… å®‰è£…å®Œæˆ"

# å¸è½½
uninstall:
	@echo "ğŸ—‘ï¸  å¸è½½å¤´æ–‡ä»¶å’Œåº“"
	@sudo rm -rf /usr/local/include/nbt
	@sudo rm -f /usr/local/lib/libnbt.*
	@sudo ldconfig
	@echo "âœ… å¸è½½å®Œæˆ"

# æ¸…ç†
clean:
	rm -rf $(LIBDIR) $(BINDIR)
	@echo "ğŸ§¹ æ¸…ç†å®Œæˆ"

# å½»åº•æ¸…ç†ï¼ˆåŒ…æ‹¬ä¾èµ–ï¼‰
distclean: clean
	rm -f *.deb *.tar.gz

# æ‰“åŒ…æˆ debï¼ˆå¯é€‰ï¼‰
deb: static
	@echo "ğŸ“¦ åˆ›å»º deb åŒ…..."
	@mkdir -p deb/usr/local/include/nbt deb/usr/local/lib
	@cp $(INCDIR)/*.h deb/usr/local/include/nbt/
	@cp $(LIB_TARGET) $(SHARED_TARGET) deb/usr/local/lib/
	@mkdir -p deb/DEBIAN
	@echo "Package: libnbt" > deb/DEBIAN/control
	@echo "Version: 1.0.0" >> deb/DEBIAN/control
	@echo "Architecture: all" >> deb/DEBIAN/control
	@echo "Maintainer: senyyds12345" >> deb/DEBIAN/control
	@echo "Description: NBT library for Minecraft" >> deb/DEBIAN/control
	@dpkg-deb --build deb libnbt_1.0.0_all.deb
	@rm -rf deb
	@echo "âœ… deb åŒ…å·²åˆ›å»º: libnbt_1.0.0_all.deb"

# å¸®åŠ©
help:
	@echo "å¯ç”¨çš„ make å‘½ä»¤ï¼š"
	@echo "  make          - ç¼–è¯‘é™æ€åº“å’ŒåŠ¨æ€åº“"
	@echo "  make static   - åªç¼–è¯‘é™æ€åº“ (.a)"
	@echo "  make shared   - åªç¼–è¯‘åŠ¨æ€åº“ (.so)"
	@echo "  make test     - ç¼–è¯‘æµ‹è¯•ç¨‹åº"
	@echo "  make run-test - è¿è¡Œæµ‹è¯•"
	@echo "  make install  - å®‰è£…åˆ°ç³»ç»Ÿ"
	@echo "  make uninstall- å¸è½½"
	@echo "  make clean    - æ¸…ç†ç¼–è¯‘æ–‡ä»¶"
	@echo "  make distclean- å½»åº•æ¸…ç†"
	@echo "  make deb      - åˆ›å»º deb åŒ…"
	@echo "  make help     - æ˜¾ç¤ºå¸®åŠ©"

.PHONY: all dirs static shared test run-test install uninstall clean distclean deb help